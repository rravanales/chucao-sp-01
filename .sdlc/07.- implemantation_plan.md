### Plan de Implementación Detallado

El siguiente plan de implementación desglosa el desarrollo de la aplicación web en pasos concretos y manejables, priorizando la construcción de la infraestructura del backend antes de la implementación completa del frontend.

**1. Configuración Inicial y Preparación del Proyecto**

- [ ] **Paso 1.1: Configuración de Variables de Entorno y Librerías Adicionales**
    *   **Descripción:** Añadir las nuevas variables de entorno requeridas para el cifrado (`ENCRYPTION_KEY`) y el envío de correos (`SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`). Instalar librerías necesarias como Nodemailer (para SMTP) y una para cifrado (ej., `crypto` de Node.js si se decide envolver su funcionalidad en una utilidad o una librería de terceros como `js-data-encryption`).
    *   **Archivos a modificar:** `.env.example`, `package.json`.
    *   **Instrucciones para el usuario:**
        *   Instalar dependencias adicionales: `npm install nodemailer` (o similar para correo), `npm install --save-dev @types/nodemailer` (si aplica).
        *   Generar una clave de cifrado fuerte y única para `ENCRYPTION_KEY` y añadirla a `.env.local`.

- [ ] **Paso 1.2: Actualización de la Configuración de Next.js para Cron Jobs**
    *   **Descripción:** Preparar el archivo de configuración de Next.js o Vercel para permitir la definición de Cron Jobs que dispararán las API Routes programadas.
    *   **Archivos a modificar:** `next.config.mjs` o `vercel.json` (si aplica una configuración explícita aquí, de lo contrario, se hará más tarde al definir las rutas).

- [ ] **Paso 1.3: Creación de Módulo de Cifrado/Descifrado**
    *   **Descripción:** Implementar un módulo en `lib/encryption.ts` que contenga funciones para cifrar y descifrar cadenas de texto, utilizando la `ENCRYPTION_KEY`.
    *   **Archivos a modificar:** `lib/encryption.ts` (nuevo).

**2. Diseño y Generación del Esquema de Base de Datos**

- [ ] **Paso 2.1: Esquemas de Datos Fundamentales (Organizaciones, Scorecards, KPIs)**
    *   **Descripción:** Crear los archivos de esquema Drizzle para las tablas `organizations`, `scorecard_elements`, y `kpis` en `db/schema/`. Definir todos los campos, relaciones (incluyendo `onDelete: "cascade"`), y tipos `pgEnum` según la especificación técnica.
    *   **Archivos a modificar:** `db/schema/organizations-schema.ts` (nuevo), `db/schema/scorecard-elements-schema.ts` (nuevo), `db/schema/kpis-schema.ts` (nuevo), `db/schema/index.ts`.

- [ ] **Paso 2.2: Esquemas de Datos para Valores y Actualizaciones de KPI**
    *   **Descripción:** Crear los archivos de esquema Drizzle para `kpi_values` y `kpi_updaters` en `db/schema/`. Asegurarse de incluir el índice único en `kpi_values` por `kpi_id` y `period_date`, así como la clave primaria compuesta para `kpi_updaters`.
    *   **Archivos a modificar:** `db/schema/kpi-values-schema.ts` (nuevo), `db/schema/kpi-updaters-schema.ts` (nuevo), `db/schema/index.ts`.

- [ ] **Paso 2.3: Esquemas para Importación de Datos (Conexiones e Importaciones Guardadas)**
    *   **Descripción:** Crear los archivos de esquema Drizzle para `import_connections` y `saved_imports` en `db/schema/`. Asegurarse de que `connection_details` y `kpi_mappings` sean de tipo `jsonb`.
    *   **Archivos a modificar:** `db/schema/import-connections-schema.ts` (nuevo), `db/schema/saved-imports-schema.ts` (nuevo), `db/schema/index.ts`.

- [ ] **Paso 2.4: Esquemas para Alertas, Grupos y Configuración de la Aplicación**
    *   **Descripción:** Crear los archivos de esquema Drizzle para `alerts`, `groups`, `group_members`, `group_permissions`, y `app_settings` en `db/schema/`. Definir todas las relaciones, tipos `pgEnum` y claves primarias compuestas.
    *   **Archivos a modificar:** `db/schema/alerts-schema.ts` (nuevo), `db/schema/groups-schema.ts` (nuevo), `db/schema/app-settings-schema.ts` (nuevo), `db/schema/index.ts`.

- [ ] **Paso 2.5: Integración Final de Esquemas en la Base de Datos**
    *   **Descripción:** Importar todos los nuevos esquemas en `db/schema/index.ts` y añadirlos al objeto `schema` en `db/db.ts`.
    *   **Archivos a modificar:** `db/db.ts`, `db/schema/index.ts`.
    *   **Instrucciones para el usuario:**
        *   **Generar Migraciones:** Ejecutar `npm run db:generate` para crear los archivos de migración SQL basados en los nuevos esquemas.
        *   **Aplicar Migraciones:** Ejecutar `npm run db:migrate` para aplicar estos cambios a su base de datos PostgreSQL.

**3. Implementación de Server Actions (Backend Core)**

- [ ] **Paso 3.1: Acciones CRUD para Organizaciones (UC-500)**
    *   **Descripción:** Crear `actions/db/organization-actions.ts`. Implementar funciones de tipo Server Action para crear, leer, actualizar y eliminar organizaciones (`createOrganizationAction`, `getOrganizationAction`, `updateOrganizationAction`, `deleteOrganizationAction`). Asegurar la validación de entrada y el manejo de errores.
    *   **Archivos a modificar:** `actions/db/organization-actions.ts` (nuevo).

- [ ] **Paso 3.2: Acciones CRUD para Elementos de Scorecard (UC-100)**
    *   **Descripción:** Crear `actions/db/scorecard-element-actions.ts`. Implementar `createScorecardElementAction`, `getScorecardElementAction`, `updateScorecardElementAction`, `deleteScorecardElementAction`, `reorderScorecardElementsAction`. Incluir lógica para manejar la jerarquía padre/hijo y unicidad de nombres.
    *   **Archivos a modificar:** `actions/db/scorecard-element-actions.ts` (nuevo).

- [ ] **Paso 3.3: Acciones CRUD y Configuración de KPIs (UC-101, UC-104)**
    *   **Descripción:** Crear `actions/db/kpi-actions.ts`. Implementar `createKpiAction`, `getKpiAction`, `updateKpiConfigurationAction`. Implementar `assignScorecardElementOwnersAction` para vincular propietarios a elementos del Scorecard.
    *   **Archivos a modificar:** `actions/db/kpi-actions.ts` (nuevo).

- [ ] **Paso 3.4: Acciones para Actualizaciones Manuales de KPI (UC-102)**
    *   **Descripción:** En `actions/db/kpi-actions.ts`, implementar `assignKpiUpdatersAction` para gestionar los usuarios encargados de actualizar KPIs y `updateKpiManualValueAction` para registrar valores manuales. Asegurar la verificación de permisos y el registro de la entrada manual.
    *   **Archivos a modificar:** `actions/db/kpi-actions.ts`.

- [ ] **Paso 3.5: Acciones CRUD para Conexiones de Importación (UC-202)**
    *   **Descripción:** Crear `actions/db/import-connections-actions.ts`. Implementar `createImportConnectionAction`, `getImportConnectionAction`, `updateImportConnectionAction`, `deleteImportConnectionAction`, `testImportConnectionAction`. Integrar las funciones de cifrado/descifrado de `lib/encryption.ts` para manejar `connection_details`.
    *   **Archivos a modificar:** `actions/db/import-connections-actions.ts` (nuevo), `lib/encryption.ts` (si se realizaron cambios).

- [ ] **Paso 3.6: Acciones CRUD para Usuarios y Grupos (UC-400, UC-402)**
    *   **Descripción:** Crear `actions/db/user-group-actions.ts`. Implementar `createUserAction`, `updateUserAction`, `deactivateUserAction` (interactuando con Clerk y la tabla `profiles`). Implementar `createGroupAction`, `getGroupAction`, `updateGroupAction`, `deleteGroupAction`, `assignGroupMembersAction`, `assignGroupPermissionsAction`.
    *   **Archivos a modificar:** `actions/db/user-group-actions.ts` (nuevo).

- [ ] **Paso 3.7: Acciones para Configuración de la Aplicación (UC-403, UC-404)**
    *   **Descripción:** Crear `actions/db/app-settings-actions.ts`. Implementar `updateTerminologyAction` y `toggleStrategyMapsAction` para gestionar la configuración global de la aplicación.
    *   **Archivos a modificar:** `actions/db/app-settings-actions.ts` (nuevo).

**4. Implementación de Server Actions Avanzadas y Automatización**

- [ ] **Paso 4.1: Acciones para Importación Estándar de Valores de KPI (UC-201, UC-203)**
    *   **Descripción:** En `actions/db/import-actions.ts`, implementar `createSavedKpiImportAction` y `executeSavedKpiImportAction`. `executeSavedKpiImportAction` debe manejar la conexión a fuentes de datos (DB/Excel), aplicar transformaciones (requiere un módulo interno para ETL), mapear y actualizar `kpi_values`.
    *   **Archivos a modificar:** `actions/db/import-actions.ts`.
    *   **Nota:** El módulo interno de ETL podría ser `lib/data-transformer.ts` (nuevo).

- [ ] **Paso 4.2: Acciones para Cálculos Automáticos de KPI y Auditoría (UC-103, UC-106)**
    *   **Descripción:** En `actions/db/kpi-actions.ts`, implementar `setKpiCalculationEquationAction`. Desarrollar un motor de cálculo (ej. `lib/kpi-calculation-engine.ts`) que pueda parsear ecuaciones, resolver dependencias entre KPIs y manejar valores nulos/N/A. Implementar `getKpiAuditTrailAction` para la trazabilidad.
    *   **Archivos a modificar:** `actions/db/kpi-actions.ts`, `lib/kpi-calculation-engine.ts` (nuevo).

- [ ] **Paso 4.3: Implementar KPIs de Rollup entre Organizaciones (UC-501)**
    *   **Descripción:** En `actions/db/kpi-actions.ts` (o `organization-actions.ts`), implementar `enableKpiRollupAction`. La lógica de cálculo de rollup se integrará en el motor de cálculo o en una función específica que agregue valores de KPIs con el mismo nombre en organizaciones hijas.
    *   **Archivos a modificar:** `actions/db/kpi-actions.ts` (o `organization-actions.ts`).

- [ ] **Paso 4.4: Acciones y API Route para Programación de Importaciones (UC-204)**
    *   **Descripción:** En `actions/db/import-actions.ts`, implementar `scheduleKpiImportAction` y `unscheduleKpiImportAction`. Crear la API Route `app/api/cron/run-scheduled-import/route.ts` que será invocada por Vercel Cron Jobs para ejecutar `executeSavedKpiImportAction`.
    *   **Archivos a modificar:** `actions/db/import-actions.ts`, `app/api/cron/run-scheduled-import/route.ts` (nuevo).
    *   **Instrucciones para el usuario:**
        *   **Configurar Vercel Cron Job:** Añadir una entrada en `vercel.json` para programar `/api/cron/run-scheduled-import` (ej., `cron: "0 * * * *"` para cada hora).

- [ ] **Paso 4.5: Acciones y API Route para Alertas (UC-300, UC-301, UC-302, UC-303, UC-304)**
    *   **Descripción:** Crear `actions/db/alert-actions.ts`. Implementar `createKpiRedAlertAction`, `configureKpiUpdateReminderAction`, `configureNoteReplyAlertAction`, `toggleRequireNoteForRedKpiAction`, `createCustomKpiAlertAction`. Crear `lib/mailer.ts` para enviar correos usando SMTP. Crear la API Route `app/api/cron/check-alerts/route.ts` para ser disparada por Cron Job que evalúe y envíe alertas.
    *   **Archivos a modificar:** `actions/db/alert-actions.ts` (nuevo), `lib/mailer.ts` (nuevo), `app/api/cron/check-alerts/route.ts` (nuevo).
    *   **Instrucciones para el usuario:**
        *   **Configurar Vercel Cron Job:** Añadir una entrada en `vercel.json` para programar `/api/cron/check-alerts`.
        *   Asegurarse de que las credenciales SMTP estén en las variables de entorno para `lib/mailer.ts`.

- [ ] **Paso 4.6: Acciones para Importación Masiva de Usuarios (UC-401)**
    *   **Descripción:** En `actions/db/user-group-actions.ts`, implementar `bulkImportUsersAction`. Esta acción parseará un archivo Excel y utilizará la API de Clerk para crear/actualizar usuarios en lote, incluyendo su asignación a grupos.
    *   **Archivos a modificar:** `actions/db/user-group-actions.ts`.

- [ ] **Paso 4.7: Acciones para Organizaciones Basadas en Plantillas y Permisos de Rollup (UC-502, UC-503)**
    *   **Descripción:** En `actions/db/organization-actions.ts`, implementar `createTemplatedOrganizationsFromDatasetAction`. En `actions/db/user-group-actions.ts`, implementar `assignRollupTreeGroupPermissionsAction`. Desarrollar la lógica de autorización en Server Actions para filtrar los datos visibles según la jerarquía de permisos del usuario.
    *   **Archivos a modificar:** `actions/db/organization-actions.ts`, `actions/db/user-group-actions.ts`.

**5. Desarrollo Frontend (UI y Experiencia de Usuario)**

- [ ] **Paso 5.1: Configurar el Layout Principal de la Aplicación (Autenticada)**
    *   **Descripción:** Crear el layout `app/(main)/layout.tsx` que incluirá componentes compartidos como una barra de navegación (Header) y una barra lateral (Sidebar) para la navegación principal dentro de la aplicación autenticada.
    *   **Archivos a modificar:** `app/(main)/layout.tsx` (nuevo), `components/shared/main-header.tsx` (nuevo), `components/shared/main-sidebar.tsx` (nuevo).

- [ ] **Paso 5.2: Páginas de Administración de Organizaciones (Listado y Detalle)**
    *   **Descripción:** Crear la página de servidor `app/(main)/organizations/page.tsx` para listar organizaciones. Crear un componente de cliente `_components/organization-card.tsx` para mostrar detalles de cada organización y un formulario de creación/edición `_components/organization-form.tsx` (usando `react-hook-form` y `zod`).
    *   **Archivos a modificar:** `app/(main)/organizations/page.tsx` (nuevo), `app/(main)/organizations/_components/organization-card.tsx` (nuevo), `app/(main)/organizations/_components/organization-form.tsx` (nuevo).

- [ ] **Paso 5.3: Páginas de Gestión de Scorecards y KPIs (Listado y Configuración)**
    *   **Descripción:** Crear la página de servidor `app/(main)/scorecards/page.tsx` para mostrar el árbol de Scorecards y KPIs. Desarrollar componentes de cliente para la creación/edición de elementos de Scorecard (`_components/scorecard-element-editor.tsx`) y KPIs (`_components/kpi-editor.tsx`).
    *   **Archivos a modificar:** `app/(main)/scorecards/page.tsx` (nuevo), `app/(main)/scorecards/_components/scorecard-element-editor.tsx` (nuevo), `app/(main)/scorecards/_components/kpi-editor.tsx` (nuevo).

- [ ] **Paso 5.4: Interfaz de Actualización Manual de KPI y Asignación de Propiedad**
    *   **Descripción:** Añadir secciones o modales en las páginas de detalle de KPI que permitan a los "Updaters" ingresar valores manualmente y a los administradores asignar propietarios y "Updaters" (UC-102, UC-104).
    *   **Archivos a modificar:** `app/(main)/scorecards/_components/kpi-editor.tsx` (actualizar), `app/(main)/scorecards/_components/kpi-manual-update-form.tsx` (nuevo).

- [ ] **Paso 5.5: Interfaz para Importaciones de Datos de KPI (Simple y Estándar)**
    *   **Descripción:** Crear la página `app/(main)/data-imports/page.tsx`. Desarrollar componentes de cliente para la gestión de conexiones (`_components/import-connection-manager.tsx`), un formulario para importaciones simples (`_components/simple-kpi-import-form.tsx`) y un asistente paso a paso para importaciones estándar (`_components/standard-kpi-import-wizard.tsx`).
    *   **Archivos a modificar:** `app/(main)/data-imports/page.tsx` (nuevo), `app/(main)/data-imports/_components/import-connection-manager.tsx` (nuevo), `app/(main)/data-imports/_components/simple-kpi-import-form.tsx` (nuevo), `app/(main)/data-imports/_components/standard-kpi-import-wizard.tsx` (nuevo).

- [ ] **Paso 5.6: Interfaz para Configuración de Alertas**
    *   **Descripción:** Crear una página de administración de alertas `app/(main)/settings/alerts/page.tsx`. Desarrollar componentes de cliente para configurar alertas de KPI "Rojo", recordatorios de actualización y alertas personalizadas (UC-300, UC-301, UC-304). Añadir la opción para requerir notas en KPI de bajo rendimiento (UC-303).
    *   **Archivos a modificar:** `app/(main)/settings/alerts/page.tsx` (nuevo), `app/(main)/settings/alerts/_components/alert-settings-form.tsx` (nuevo).

- [ ] **Paso 5.7: Interfaz para Administración de Usuarios, Grupos y Permisos**
    *   **Descripción:** Crear páginas de administración `app/(main)/settings/users/page.tsx` y `app/(main)/settings/groups/page.tsx`. Desarrollar componentes de cliente para gestionar usuarios individuales, importar usuarios masivamente y configurar grupos/permisos (UC-400, UC-401, UC-402).
    *   **Archivos a modificar:** `app/(main)/settings/users/page.tsx` (nuevo), `app/(main)/settings/groups/page.tsx` (nuevo), `app/(main)/settings/users/_components/user-management-table.tsx` (nuevo), `app/(main)/settings/groups/_components/group-permission-config.tsx` (nuevo).

- [ ] **Paso 5.8: Interfaz para Personalización de Terminología y Strategy Maps**
    *   **Descripción:** Añadir una sección en la página de configuración de la aplicación `app/(main)/settings/app/page.tsx` que permita al administrador personalizar la terminología y activar/desactivar la funcionalidad de Strategy Maps (UC-403, UC-404).
    *   **Archivos a modificar:** `app/(main)/settings/app/page.tsx` (nuevo).

**6. Integración y Pruebas**

- [ ] **Paso 6.1: Conexión de UI con Server Actions y Notificaciones**
    *   **Descripción:** Conectar todos los formularios y elementos interactivos del frontend con sus respectivas Server Actions. Implementar el manejo de la respuesta `ActionState` para mostrar notificaciones de éxito/error usando `useToast` y revalidar la UI (`router.refresh()`) según sea necesario.
    *   **Archivos a modificar:** Todos los archivos de componentes de cliente y páginas relevantes.

- [ ] **Paso 6.2: Implementación de Verificaciones de Autorización en el Frontend**
    *   **Descripción:** Añadir lógica en los componentes de UI para controlar la visibilidad o la habilitación de elementos/acciones basándose en los permisos del usuario autenticado, obteniendo estos permisos desde las Server Actions o un contexto de cliente.
    *   **Archivos a modificar:** Múltiples componentes de UI relevantes.

- [ ] **Paso 6.3: Implementar Pruebas Unitarias para Server Actions y Lógica Crítica**
    *   **Descripción:** Crear un directorio `__tests__/server-actions/` (o similar) y escribir pruebas unitarias exhaustivas para las Server Actions más críticas (ej., las de cálculo de KPI, importación, permisos), mockeando las dependencias externas (Drizzle, Clerk, etc.).
    *   **Archivos a modificar:** `__tests__/server-actions/kpi-actions.test.ts` (nuevo), `__tests__/server-actions/import-actions.test.ts` (nuevo), etc.

- [ ] **Paso 6.4: Implementar Pruebas de Integración para Flujos de Datos**
    *   **Descripción:** Crear pruebas de integración para validar la interacción entre múltiples Server Actions y la base de datos (ej., la creación de una organización, la adición de un Scorecard Element y un KPI a ella).
    *   **Archivos a modificar:** `__tests__/integration/core-flow.test.ts` (nuevo), etc.
    *   **Instrucciones para el usuario:**
        *   Configurar una base de datos de prueba separada para las pruebas de integración para evitar afectar el entorno de desarrollo.

- [ ] **Paso 6.5: Configurar y Escribir Pruebas End-to-End (E2E)**
    *   **Descripción:** Configurar Playwright para las pruebas E2E. Escribir escenarios E2E para los flujos de usuario más críticos, validando la interacción completa desde el frontend hasta el backend y la base de datos (ej., un usuario se registra, crea un Scorecard, define un KPI, y actualiza un valor).
    *   **Archivos a modificar:** `e2e/auth-kpi-flow.spec.ts` (nuevo), etc.

- [ ] **Paso 6.6: Revisión y Refinamiento de la Calidad del Código y Rendimiento**
    *   **Descripción:** Realizar una revisión general del código para asegurar la adherencia a las reglas de ESLint y Prettier. Optimizar el rendimiento de la carga y visualización de Scorecards y KPIs. Verificar que las animaciones de Framer Motion se integren fluidamente.
    *   **Archivos a modificar:** Múltiples archivos de código.

---

### Resumen del Enfoque General y Consideraciones Clave

El plan de implementación propuesto sigue una metodología que prioriza la **construcción de una base de datos sólida y una lógica de negocio robusta en el backend** antes de la implementación exhaustiva del frontend. Este enfoque garantiza que la funcionalidad central y la seguridad de los datos estén bien establecidas desde el principio, proporcionando una base estable para la experiencia del usuario.

**Consideraciones Clave para la Implementación:**

*   **Seguridad y Cifrado:** La gestión de **credenciales sensibles para las conexiones de importación** es un punto crítico. La solución propuesta de cifrado a nivel de aplicación con una clave de entorno (`ENCRYPTION_KEY`) debe implementarse y probarse con el máximo rigor para garantizar la protección de datos.
*   **Automatización y Vercel Cron Jobs:** La funcionalidad de importaciones y alertas programadas depende directamente de la **configuración correcta de Vercel Cron Jobs** que disparen las API Routes específicas. Esto requerirá atención en el despliegue y monitoreo.
*   **Complejidad del Motor de Cálculo de KPI:** El diseño e implementación del **motor para cálculos automáticos y KPIs de rollup** será una tarea compleja, que deberá manejar dependencias, diferentes tipos de agregación y valores nulos. Un diseño modular en `lib/kpi-calculation-engine.ts` es crucial.
*   **Gestión de Permisos Escalable:** La implementación de **permisos basados en la jerarquía organizacional y los "grupos de árboles de rollup"** es fundamental para la escalabilidad del sistema, permitiendo un control granular del acceso a datos para un gran número de usuarios sin una gestión manual excesiva.
*   **Manejo de Errores y Feedback Consistente:** El uso uniforme de `ActionState<T>` para las respuestas de Server Actions y `useToast` en el frontend es vital para proporcionar a los usuarios una **retroalimentación clara y consistente** sobre el éxito o el fracaso de sus operaciones.
*   **Pruebas Integrales:** Aunque el plan detalla los tipos y el alcance de las pruebas (unitarias, integración, E2E), la creación de **pruebas exhaustivas para todas las funcionalidades, especialmente las más complejas**, será una inversión significativa y continua para asegurar la calidad y fiabilidad de la aplicación.

Este plan busca ser una guía detallada y accionable para el sistema de generación de código, garantizando que cada componente se construya de manera lógica y que el resultado final sea una aplicación web funcional, segura y alineada con los requisitos del proyecto.